---
title: "DATA 607 Project 1"
author: "Magnus Skonberg"
date: "`r Sys.Date()`"
output: 
  openintro::lab_report: default
  html_document:
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include=FALSE}
#load relevant libraries
library(tidyverse) #includes stringr package
library(stringi)
```

## Background
In this project, we’re given a text file with chess tournament results where the information has some structure. Our job is to create an R Markdown file that generates a .CSV file (that could for example be imported into a SQL database)
with the following information for all of the players:

*Player Name | State | Total Points | Pre-Rating | Avg Opp Pre-Rating*

For the first player, the information would be:
*Gary Hua, ON, 6.0, 1794, 1605*

*1605 was calculated by using the pre-tournament opponents’ ratings of 1436, 1563, 1600, 1610, 1649, 1663, 1716, and dividing by the total number of games played.*

## Step 1
Import the data from the text file into a list variable.

```{r}
chess_input <- read.table(url("https://raw.githubusercontent.com/Magnus-PS/CUNY-SPS-DATA-607/Project-1/tournamentinfo.txt"), sep = ",")

head(chess_input)
```
From the output above, we can see that the header has been included and that the data is not organized. Thus, *prior to* outputting our data in the desired form, we'll have to pull variables, etc. from this set in an organized manner.

## Step 2

Use regular expressions to wrangle data and sort through our 'raw' data set for what is essential / desired.

Remove header, "---" (dashed lines), and "  " excess white spaces.

```{r}
#Remove header
chess_input <- chess_input[-c(1:4),]

#Exclude every 3rd row (of dashed lines)
i <- seq(0, 192, 3)
chess_input <- chess_input[-i]

#Compress white space for readability ... maybe not essential
chess_input <- str_replace_all(chess_input, "\\s+", " ")

head(chess_input)

```

If we observe the result of our processed data, we see that we have alternating rows of values where the values themselves are separated by "|"s.

**Odd rows**: ID | Player Name | Total Pts | W/L/D Opp# ...

**Even rows**: State | USCF ID | Rtg Pre -> Post | ...

We could sort by row value *and then* extract the essential bits from these sorted data sets.

```{r}
#Sort data by row value for easier extraction later.

o_rows <- seq(1, 128, 2)
e_rows <- seq(2, 128, 2)
  
o_chessdata <- data.frame(x=chess_input[o_rows])
e_chessdata <- data.frame(x=chess_input[e_rows])

string_o <- toString(o_chessdata)
string_e <- toString(e_chessdata)

```
We now have 2 dataframes of characters with desired variables to be extracted from these dataframes based on their location (described earlier). 

Here we're going to match patterns with regular expressions to pull desired variables from the dataframes (shown above) to later re-unite as one dataframe *prior to* their output via .csv file.

```{r}
#Extract player IDs: 
id<-unlist(str_extract_all(string_o,"\\d{1,2} \\| "))
id<-unlist(str_extract_all(id, "\\d{1,2}"))

#Extract player names:
name <-unlist(str_extract_all(string_o,"\\w+ ?\\w+ \\w+"))

#Extract player point total:
pt_total <-unlist(str_extract_all(string_o,"\\d.\\d"))

#Extract player state:
state <-unlist(str_extract_all(string_e, " \\w{2} \\| "))
state<-unlist(str_extract_all(state, "\\w{2}"))

#Extract player pre-rating:
prerating <-unlist(str_extract_all(string_e, "(R:\\s*)(\\d+)"))
prerating <-unlist(str_extract_all(prerating, "(\\d+)"))

```

At this point, we've extracted the players ID, name, point total, state, and pre-rating and created lists of 1 (strings). Now we would like to combine what we've extracted (the variables of interest) into one table. We can then create a versus table corresponding to each chess player's ID and use that table in combination with their ID and their opponents ID and preranking to compute our avg_opponent_preranking.

```{r}

#Build dataframe of all variables up to this point, create a mapping matrix of 'versus' and then use this matrix in combination with the built dataframe to compute avg_opp_prerating

###Refer to Jered or Rick's here ... I've hit a ROADBLOCK

#Create matrix mapping of 'versus opponents'
vs<-unlist(str_extract_all(toString(o_chessdata),"\\|[0-9].*"))
vs<-unlist(str_replace_all(vs, "\\s{1,2}\\|", "0|"))
vs<-unlist(str_extract_all(vs,"\\s\\d{1,2}"))
vs #I'd referred to Jered's here but for some reason the structure of my output is different ... 64 x 7= 448 and thus there are 16 extra values ... where do they come from and how do I get rid of them ... then how do I create a matrix in the proper order of extry so that I can account non-value entries when building out this matrix (as highlighted on slack)

#How do I get it so that I start a new row every 7 values?

#once I've figured that out ... use a for loop and ID#s to iterate over preratings in building avg_opponent ratings

```


```{r}

opponents<-matrix(nrow=64,ncol=7)

#Step 3: use 'versus opponents' matrix and reference to combined dataframe to calculate avg_opp_prerating

```

```{r}

#Combine lists of strings into dataframe

combined <- data.frame(id, name, state, pt_total, prerating)
colnames(combined) <- c("ID", "Player Name", "Player's State", "Point Total", "Pre Rating") #waiting to calculate and add avg_opp_rating

```

## Step 3
Generate a .csv file.

```{r}
#Insert r code here

#ie. write.csv(Your DataFrame,"Path where you'd like to export the DataFrame\\File Name.csv", row.names = FALSE)


```
