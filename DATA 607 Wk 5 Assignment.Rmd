---
title: "DATA 605 HW 5"
author: "Magnus Skonberg"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: true
        toc_float: true
        number_sections: false
        theme: cerulean
        highlight: tango
        font-family: "Arial"
---

```{r load-packages, include=FALSE}
library(tidyverse)
library(openintro)
library(dplyr)
library(tidyr)
library(RCurl)
library(ggplot2)
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Background

The purpose of this assignment is to *tidy and transform data*. The dataset of interest describes arrival delays for two airlines across five destinations and our task is to: 

(1) Create a .csv file in a "wide" structure.
(2) Read this .csv and use tidyr and dplyr to tidy and transform.
(3) Analyze arrival delays between the airlines.
(4) Provide the .rmd file, rpubs link, and descriptions of steps taken.

--------------------------------------------------------------------------------

\clearpage

### (1) Create a .csv.

A wide format .csv is created per assignment description and [uploaded to github.](https://github.com/Magnus-PS/CUNY-SPS-DATA-607/blob/Assignment-5/Wcoast_airline_comp.csv)

With the .csv available on github, we shift to reading from this file *prior to* tidying and transforming the data therein.

### (2) Read, tidy, and transform.

We read the .csv (in its raw form) from github and store corresponding data in a variable named "data" (I know ... very creative).

```{r}
#Get URL, read .csv (in raw form) from github, and put into tabular form
url <- getURL("https://raw.githubusercontent.com/Magnus-PS/CUNY-SPS-DATA-607/Assignment-5/Wcoast_airline_comp.csv")
data <- read.csv(text = url)
data <- tbl_df(data)

#Show what we're working with:
data

```

Once we've read from .csv and stored our data, we shift to tidying and transforming the data therein.

To start, we tidy:

```{r}
#Tidy / shape our data (using tidyr)

##Provide fitting column names for the 1st and 2nd column
names(data)[names(data) == "X"] <- "Airline"
names(data)[names(data) == "X.1"] <- "Status"

##Remove rows with "NA" from dataset
data <- na.omit(data)

##Make observations from variables using gather()
##This is also when we convert from a 'wide' to 'long' format
data_long <- gather(data, "Airport", "n", 3:7, factor_key=TRUE)


##Initialize counter then fill empty Airline elements via for loop
n <- 2 

for (n in c(2,6,10,14,18)){
    data_long$Airline[n] <- "ALASKA"
    data_long$Airline[n+2] <- "AM WEST"
    n <- n+4
}

##Make variables from observations using spread()
data_long <- spread(data_long, "Status", "n")
data_long

qplot(x=delayed, y=`on time`, data=data_long, col= Airline, main="On Time v Delayed Flights", xlab="# of delayed flights", ylab="# of on time flights")

```

What started as a *less clear* 5x7 'wide' table ("data") is now a  *tidy* 4x10 'long' table ("data_long") with an associated plot (above) showing the relationship between on time and delayed flights for each Airline. 

*Each point on the plot represents an airport, with the point of this plot being to show the range in scale (ie. # of flights) between different data in our data set.*

...

With tidying complete, we move on to transforming our data. We'll make use of dplyr() to transform data and perform mathematical calculations to solve for our variables. After this point, we should have all we need to *clearly* observe the difference in delays between the two airlines.

We can identify our high-level variables of interest as:
(1) What airline has the lowest overall probability of arrival delay?
(2) At each airport, which airline has the lower probability of arrival delay?

To calculate (1), we can take the total flights delayed and on time per airline, sum them together, and observe the probability of delay for each airline.

```{r}
#Transform the data: dplyr

##Compute the probability of an Alaska flight arriving on time
ak <- filter(data_long, Airline == "ALASKA")
ak_on_time <- sum(ak$`on time`) / (sum(ak$delayed) + sum(ak$`on time`))
round(ak_on_time, digits = 3)

#Compute the probability of an AM West flight arriving on time
aw_flts <- filter(data_long, Airline == "AM WEST")
aw_on_time <- sum(aw_flts$`on time`) / (sum(aw_flts$delayed) + sum(aw_flts$`on time`))
round(aw_on_time, digits = 3)

```
We first observe that **AM West has a better *total* on time probability.** Meaning that for on time flight total over total number of flights (incl. delay) AM West has a better on time probability than ALASKA.

But we can't close on this conclusion as it's very high level. We've got to observe the probabilities at each individual Airport. Thus exploring, (2) At each airport, which airline has the lower probability of arrival delay?

### (3) Analyze and compare.

Compare arrival delays between the two airlines.

```{r}
#Initialize counter then create new column on_time_prob to store the on time probability for each Airline at each Airport via for loop
n <- 1

for (n in c(1:10)){
    data_long$on_time_prob[n] <- round(data_long$`on time`[n] / (data_long$`on time`[n] + data_long$delayed[n]), digits = 3)
    n <- n+1
}

data_long

qplot(x=Airport, y=on_time_prob, data=data_long, col= Airline, main="On Time Probability v Airport", xlab="Airport", ylab="Probability of an On Time Arrival")
```

Using the table and plot above, we can observe that for every Airport, Alaskan Air has a better probability of being on time.

Thus there is a discrepancy in the data. At a macro scale it would seem AM WEST would be the better Airline to choose but when we zoom on each Airline's performance per Airport we see that ALASKA actually performs better.

### (4) Conclude and recommend.

The reason that the *total* on time probability favors AM WEST is because AM WEST has 4840 flights for Phoenix that are on time (recall our earlier plot), and this is its best performing Airport. If we compare this value to ALASKA's largest volume of flights (1841 at Seattle), we see that it's nearly 3x the volume. 

While ALASKA may have a better on time probability than AM WEST for arrival in Seattle (and every other airport for that matter), AM WEST has ~3x volume on its best performing airport and ALASKA has its greatest volume on one of its lowest performing airports. Thus volume sways the total in AM WEST's favor and paints a "different tale".

**In closing, it may *seem* that AM WEST is better if we just take flight totals into account *but* once we actually dig in and look at on time probabilities per Airline and Airport, we see that ALASKA is the better airline to choose for on time arrival. It outperforms AM WEST at every airport (including Phoenix).**